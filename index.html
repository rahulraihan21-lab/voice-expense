<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Finance Voice Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --accent-primary: #38bdf8;
            --accent-success: #4ade80;
            --accent-danger: #f87171;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Hind Siliguri', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; padding: 20px; padding-bottom: 120px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Dashboard */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .card { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 16px; position: relative; overflow: hidden; }
        .card.full { grid-column: span 2; border-left: 4px solid var(--accent-primary); }
        .card h3 { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
        .card .amount { font-size: 1.4rem; font-weight: 700; margin-top: 5px; }
        
        /* Private Section */
        .private-blur { filter: blur(10px); pointer-events: none; }
        .vault-lock { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(15, 23, 42, 0.9); z-index: 5; border-radius: 16px; cursor: pointer; }

        /* Voice Status & Review Area */
        .voice-box { background: rgba(56, 189, 248, 0.05); padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 20px; border: 1px solid #1e293b; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #64748b; margin-right: 5px; }
        .status-dot.active { background: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        /* Review Card (Critical Requirement) */
        #reviewContainer { display: none; background: #1e293b; border: 1px solid var(--accent-primary); padding: 15px; border-radius: 16px; margin-bottom: 20px; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .review-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 10px; }
        .btn-confirm { background: var(--accent-success); color: #064e3b; width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: none; color: var(--accent-danger); border: none; font-size: 0.8rem; cursor: pointer; margin-top: 5px; }

        /* Lists */
        .transaction-list { list-style: none; margin-top: 10px; }
        .item { background: var(--card-bg); padding: 12px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid transparent; }
        .item.expense { border-left-color: var(--accent-danger); }
        .item.income { border-left-color: var(--accent-success); }
        .btn-del { background: none; border: 1px solid #334155; color: #888; padding: 4px 8px; border-radius: 6px; cursor: pointer; }

        /* Navigation */
        .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; display: flex; gap: 10px; z-index: 100; }
        .btn { flex: 1; padding: 15px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main { background: var(--accent-primary); color: #000; box-shadow: 0 4px 15px rgba(56, 189, 248, 0.4); }
        .btn-stop { background: var(--accent-danger); color: white; display: none; }
        .btn-sec { background: #334155; color: white; }

        .overlay { position: fixed; inset: 0; background: var(--bg-color); z-index: 1000; padding: 20px; display: none; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>Smart Finance <span style="color:var(--accent-primary)">Pro</span></h2>
        <button onclick="lockVault()" style="background:none; border:1px solid #334155; color:var(--text-muted); padding:5px 10px; border-radius:8px;">üîí ‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div class="summary-grid">
        <div class="card full">
            <div id="vaultOverlay" class="vault-lock" onclick="unlockVault()"><span>üîì ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡ßü‡ßá ‡¶∏‡¶û‡ßç‡¶ö‡ßü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</span></div>
            <div id="vaultContent" class="private-blur">
                <h3>‡¶Æ‡ßã‡¶ü ‡¶∏‡¶û‡ßç‡¶ö‡ßü</h3>
                <div id="sum-net" class="amount" style="color:var(--accent-success)">‡ß≥ 0</div>
                <div style="display:flex; gap:20px; margin-top:10px;">
                    <div><small>‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü</small><br><b id="sum-total-inc">‡ß≥ 0</b></div>
                    <div><small>‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</small><br><b id="sum-total-exp">‡ß≥ 0</b></div>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö</h3>
            <div id="sum-today-exp" class="amount" style="color:var(--accent-danger)">‡ß≥ 0</div>
        </div>
        <div class="card">
            <h3>‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö</h3>
            <div id="sum-month-exp" class="amount">‡ß≥ 0</div>
        </div>
    </div>

    <div class="voice-box">
        <div><span id="dot" class="status-dot"></span> <span id="statusText">‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã‡¶´‡ßã‡¶® ‡¶¨‡¶®‡ßç‡¶ß</span></div>
        <div id="livePreview" style="font-size: 0.9rem; color: var(--accent-primary); min-height: 25px; margin-top: 8px; font-weight: 600;"></div>
    </div>

    <div id="reviewContainer">
        <h4 style="margin-bottom:10px; color: var(--accent-success);">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®:</h4>
        <div id="reviewList"></div>
        <button class="btn-confirm" onclick="confirmAndSave()">‚úÖ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button class="btn-cancel" onclick="cancelReview()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <h3>‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</h3>
    <ul id="recentList" class="transaction-list"></ul>
</div>

<div id="reportOverlay" class="overlay">
    <div style="display:flex; justify-content: space-between; align-items:center;">
        <h3>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ì ‡¶¨‡¶æ‡ßé‡¶∏‡¶∞‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>
        <button onclick="closeReports()" class="btn-sec" style="padding:5px 15px; border-radius:8px;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin:20px 0;">
        <div style="background:#1e293b; padding:15px; border-radius:12px;">
            <small>‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏</small><br><b id="rep-month" style="font-size:1.2rem;">‡ß≥ 0</b>
        </div>
        <div style="background:#1e293b; padding:15px; border-radius:12px;">
            <small>‡¶è‡¶á ‡¶¨‡¶õ‡¶∞</small><br><b id="rep-year" style="font-size:1.2rem;">‡ß≥ 0</b>
        </div>
    </div>
    <canvas id="reportChart" style="background:#1e293b; border-radius:12px; padding:10px;"></canvas>
    <ul id="fullList" class="transaction-list" style="margin-top:20px;"></ul>
</div>

<div class="nav-bar">
    <button id="btnStart" class="btn btn-main" onclick="startRecognition()">üé§ ‡¶¨‡¶≤‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    <button id="btnStop" class="btn btn-stop" onclick="stopRecognition()">üõë ‡¶•‡¶æ‡¶Æ‡ßÅ‡¶®</button>
    <button class="btn btn-sec" onclick="openReports()">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
</div>

<script>
    let transactions = JSON.parse(localStorage.getItem('sf_pro_v3_data')) || [];
    let passCode = localStorage.getItem('sf_pro_pass') || '1234';
    let pendingEntries = []; // Temporary storage for review

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.continuous = true;
    recognition.lang = 'bn-BD';
    recognition.interimResults = true;

    recognition.onresult = (event) => {
        let interim = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            const text = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                prepareForReview(text);
            } else {
                interim = text;
            }
        }
        document.getElementById('livePreview').innerText = interim;
    };

    function prepareForReview(input) {
        // Convert Bangla digits to English
        const text = input.replace(/[‡ß¶-‡ßØ]/g, d => "‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ".indexOf(d));
        const segments = text.split(/(‡¶è‡¶¨‡¶Ç|‡¶Ü‡¶∞|,)/);
        let detectedItems = [];

        segments.forEach(s => {
            const match = s.match(/\d+/);
            if (match) {
                const amount = parseInt(match[0]);
                const type = (text.includes("‡¶á‡¶®‡¶ï‡¶æ‡¶Æ") || text.includes("‡¶Ü‡ßü")) ? 'income' : 'expense';
                let cat = s.replace(/\d+/g, '').replace(/‡¶ü‡¶æ‡¶ï‡¶æ|‡¶á‡¶®‡¶ï‡¶æ‡¶Æ|‡¶Ü‡ßü/g, '').trim() || (type === 'income' ? '‡¶Ü‡ßü' : '‡¶ñ‡¶∞‡¶ö');
                detectedItems.push({ type, amount, cat });
            }
        });

        if (detectedItems.length > 0) {
            pendingEntries = detectedItems;
            showReviewCard();
        }
    }

    function showReviewCard() {
        const listEl = document.getElementById('reviewList');
        listEl.innerHTML = pendingEntries.map(item => `
            <div class="review-item">
                <span><b>${item.cat}</b> (${item.type === 'income' ? '‡¶Ü‡ßü' : '‡¶¨‡ßç‡¶Ø‡ßü'})</span>
                <span style="color:var(--accent-primary)">‡ß≥ ${item.amount}</span>
            </div>
        `).join('');
        document.getElementById('reviewContainer').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function confirmAndSave() {
        const now = new Date();
        pendingEntries.forEach(item => {
            transactions.unshift({
                id: Date.now() + Math.random(),
                type: item.type,
                amount: item.amount,
                category: item.cat,
                date: now.toISOString(),
                month: now.getMonth(),
                year: now.getFullYear()
            });
        });
        localStorage.setItem('sf_pro_v3_data', JSON.stringify(transactions));
        cancelReview();
        render();
        alert("‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
    }

    function cancelReview() {
        pendingEntries = [];
        document.getElementById('reviewContainer').style.display = 'none';
        document.getElementById('livePreview').innerText = "";
    }

    // Security & Data
    function unlockVault() {
        if (prompt("‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:") === passCode) {
            document.getElementById('vaultOverlay').style.display = 'none';
            document.getElementById('vaultContent').classList.remove('private-blur');
        } else { alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!"); }
    }
    function lockVault() {
        document.getElementById('vaultOverlay').style.display = 'flex';
        document.getElementById('vaultContent').classList.add('private-blur');
    }

    function calculate(type, period) {
        const now = new Date();
        return transactions.filter(t => {
            if (type !== 'all' && t.type !== type) return false;
            const d = new Date(t.date);
            if (period === 'today') return d.toDateString() === now.toDateString();
            if (period === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            if (period === 'year') return d.getFullYear() === now.getFullYear();
            return true;
        }).reduce((sum, t) => sum + (t.type === 'expense' && type === 'all' ? -t.amount : t.amount), 0);
    }

    function render() {
        const totalInc = calculate('income', 'all');
        const totalExp = calculate('expense', 'all');
        
        document.getElementById('sum-net').innerText = `‡ß≥ ${totalInc - totalExp}`;
        document.getElementById('sum-total-inc').innerText = `‡ß≥ ${totalInc}`;
        document.getElementById('sum-total-exp').innerText = `‡ß≥ ${totalExp}`;
        document.getElementById('sum-today-exp').innerText = `‡ß≥ ${calculate('expense', 'today')}`;
        document.getElementById('sum-month-exp').innerText = `‡ß≥ ${calculate('expense', 'month')}`;
        
        document.getElementById('rep-month').innerText = `‡ß≥ ${calculate('expense', 'month')}`;
        document.getElementById('rep-year').innerText = `‡ß≥ ${calculate('expense', 'year')}`;

        const html = transactions.slice(0, 5).map(t => `
            <li class="item ${t.type}">
                <div><b>${t.category}</b><br><small>${new Date(t.date).toLocaleDateString('bn-BD')}</small></div>
                <div style="font-weight:bold;">‡ß≥ ${t.amount}</div>
            </li>
        `).join('');
        document.getElementById('recentList').innerHTML = html || '<p style="text-align:center; color:#444;">‡¶ï‡ßã‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡ßá‡¶á</p>';
    }

    // Recognition Controls
    function startRecognition() {
        recognition.start();
        document.getElementById('btnStart').style.display = 'none';
        document.getElementById('btnStop').style.display = 'flex';
        document.getElementById('dot').classList.add('active');
        document.getElementById('statusText').innerText = "‡¶∂‡ßÅ‡¶®‡¶õ‡¶ø...";
    }
    function stopRecognition() {
        recognition.stop();
        document.getElementById('btnStart').style.display = 'flex';
        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('dot').classList.remove('active');
        document.getElementById('statusText').innerText = "‡¶¨‡¶®‡ßç‡¶ß";
    }

    function openReports() { 
        document.getElementById('reportOverlay').style.display = 'block';
        updateChart();
        const fullHtml = transactions.map(t => `
            <li class="item ${t.type}">
                <div><b>${t.category}</b> (${t.type === 'income' ? '‡¶Ü‡ßü' : '‡¶¨‡ßç‡¶Ø‡ßü'})</div>
                <span>‡ß≥ ${t.amount}</span>
            </li>
        `).join('');
        document.getElementById('fullList').innerHTML = fullHtml;
    }
    function closeReports() { document.getElementById('reportOverlay').style.display = 'none'; }

    let chart;
    function updateChart() {
        const ctx = document.getElementById('reportChart').getContext('2d');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['‡¶Ü‡ßü', '‡¶¨‡ßç‡¶Ø‡ßü'],
                datasets: [{ data: [calculate('income','all'), calculate('expense','all')], backgroundColor: ['#4ade80', '#f87171'] }]
            },
            options: { plugins: { legend: { display: false } } }
        });
    }

    render();
</script>
</body>
</html>
