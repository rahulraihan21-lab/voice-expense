<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Finance Voice Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --accent-primary: #38bdf8;
            --accent-success: #4ade80;
            --accent-danger: #f87171;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Hind Siliguri', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; padding: 20px; padding-bottom: 120px; }
        .container { max-width: 600px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 1.5rem; color: var(--accent-primary); }

        /* Summary Cards */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .card { background: var(--card-bg); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .card.full-width { grid-column: span 2; border-bottom: 3px solid var(--accent-primary); }
        .card h3 { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .card .amount { font-size: 1.3rem; font-weight: 700; }
        .income-text { color: var(--accent-success); }
        .expense-text { color: var(--accent-danger); }

        /* Voice Status */
        .voice-status { text-align: center; margin-bottom: 20px; min-height: 40px; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #64748b; margin-right: 8px; }
        .status-dot.active { background: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
        .transcript-preview { font-style: italic; font-size: 0.9rem; color: var(--accent-primary); margin-top: 5px; }

        /* Lists */
        .section-title { margin: 20px 0 10px; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }
        .transaction-list { list-style: none; }
        .transaction-item { background: var(--card-bg); margin-bottom: 10px; padding: 12px 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .item-info div:first-child { font-weight: 600; }
        .item-info div:last-child { font-size: 0.75rem; color: var(--text-muted); }
        .btn-delete { background: rgba(248, 113, 113, 0.1); border: 1px solid var(--accent-danger); color: var(--accent-danger); padding: 5px 10px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; }

        /* Controls */
        .controls { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; width: 95%; max-width: 500px; z-index: 100; }
        .btn { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; }
        .btn-primary { background: var(--accent-primary); color: #000; }
        .btn-stop { background: var(--accent-danger); color: white; display: none; }
        .btn-secondary { background: #334155; color: white; }
        .btn-danger-all { background: #450a0a; color: #f87171; border: 1px solid #f87171; width: 100%; margin-top: 20px; padding: 12px; }

        /* Report View */
        #reportOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 1000; padding: 20px; display: none; overflow-y: auto; }
        .chart-container { margin-top: 20px; background: var(--card-bg); padding: 15px; border-radius: 16px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Smart Finance Voice Pro</h1>
    </header>

    <div class="voice-status">
        <div><span id="statusDot" class="status-dot"></span> <span id="statusLabel">‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã‡¶´‡ßã‡¶® ‡¶¨‡¶®‡ßç‡¶ß</span></div>
        <div id="liveTranscript" class="transcript-preview"></div>
    </div>

    <div class="summary-grid">
        <div class="card full-width">
            <h3>‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</h3>
            <div id="sum-net" class="amount">‡ß≥ 0</div>
        </div>
        <div class="card">
            <h3>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Ü‡ßü</h3>
            <div id="sum-income" class="amount income-text">‡ß≥ 0</div>
        </div>
        <div class="card">
            <h3>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö</h3>
            <div id="sum-today" class="amount expense-text">‡ß≥ 0</div>
        </div>
    </div>

    <div class="section-title">
        <span>‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®</span>
        <button onclick="toggleReports(true)" style="background:none; border:none; color:var(--accent-primary); cursor:pointer;">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>
    </div>

    <ul id="recentList" class="transaction-list"></ul>
</div>

<div id="reportOverlay">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2>
        <button class="btn btn-secondary" onclick="toggleReports(false)" style="flex:none; padding: 8px 15px;">‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
    
    <div class="chart-container">
        <canvas id="mainChart"></canvas>
    </div>

    <h3 style="margin:20px 0 10px;">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h3>
    <ul id="fullList" class="transaction-list"></ul>

    <button class="btn btn-danger-all" onclick="clearAllData()">üóëÔ∏è ‡¶∏‡¶ï‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶® (‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá)</button>
    
    <div style="margin: 30px 0; text-align: center;">
        <button onclick="changePassword()" style="color:var(--text-muted); background:none; border:none; text-decoration: underline;">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>
</div>

<div class="controls">
    <button id="btnStart" class="btn btn-primary" onclick="startListening()">üé§ ‡¶¨‡¶≤‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    <button id="btnStop" class="btn btn-stop" onclick="stopListening()">üõë ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    <button class="btn btn-secondary" onclick="toggleReports(true)">üìä ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
</div>

<script>
    let transactions = JSON.parse(localStorage.getItem('sfvp_data')) || [];
    let appPassword = localStorage.getItem('sfvp_pass') || '1234';
    
    // Voice Duplicate Prevention
    let lastProcessedText = "";
    let lastProcessedTime = 0;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isListening = false;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.lang = 'bn-BD';
        recognition.interimResults = true;

        recognition.onresult = (event) => {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcript = event.results[i][0].transcript.trim();
                if (event.results[i].isFinal) {
                    // Duplicate prevention logic (debounce 1.5s and text match)
                    const now = Date.now();
                    if (transcript !== lastProcessedText || (now - lastProcessedTime > 1500)) {
                        processVoiceCommand(transcript);
                        lastProcessedText = transcript;
                        lastProcessedTime = now;
                    }
                } else {
                    interimTranscript += transcript;
                }
            }
            document.getElementById('liveTranscript').innerText = interimTranscript;
        };

        recognition.onend = () => { if (isListening) recognition.start(); };
    }

    const bn2en = (str) => {
        const digits = {'‡ß¶':0,'‡ßß':1,'‡ß®':2,'‡ß©':3,'‡ß™':4,'‡ß´':5,'‡ß¨':6,'‡ß≠':7,'‡ßÆ':8,'‡ßØ':9};
        return str.replace(/[‡ß¶-‡ßØ]/g, d => digits[d]);
    };

    function processVoiceCommand(text) {
        const normalized = bn2en(text);
        
        // Command Actions
        if (text.includes("‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü") || text.includes("‡¶∏‡¶¨ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶ì")) {
            toggleReports(true); return;
        }

        // Split by markers to handle multiple entries in one go
        const segments = normalized.split(/(‡¶è‡¶¨‡¶Ç|‡¶Ü‡¶∞|,)/);
        
        segments.forEach(seg => {
            const amountMatch = seg.match(/\d+/);
            if (amountMatch) {
                const amount = parseInt(amountMatch[0]);
                const type = (normalized.includes("‡¶á‡¶®‡¶ï‡¶æ‡¶Æ") || normalized.includes("‡¶Ü‡ßü")) ? 'income' : 'expense';
                let category = seg.replace(/\d+/g, '').replace(/‡¶ü‡¶æ‡¶ï‡¶æ|‡¶á‡¶®‡¶ï‡¶æ‡¶Æ|‡¶Ü‡ßü/g, '').trim();
                if (!category) category = (type === 'income' ? "‡¶Ü‡ßü" : "‡¶ñ‡¶∞‡¶ö");
                
                saveTransaction(type, amount, category);
            }
        });
    }

    function saveTransaction(type, amount, category) {
        const now = new Date();
        const entry = {
            id: Date.now() + Math.random(),
            type, amount, category,
            date: now.toISOString(),
            weekNumber: getWeekNumber(now),
            month: now.getMonth(),
            year: now.getFullYear()
        };
        transactions.unshift(entry);
        syncData();
    }

    function deleteTransaction(id) {
        if (confirm("‡¶è‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            const pass = prompt("‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:");
            if (pass === appPassword) {
                transactions = transactions.filter(t => t.id !== id);
                syncData();
            } else { alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!"); }
        }
    }

    function clearAllData() {
        const pass = prompt("‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:");
        if (pass === appPassword) {
            if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§? ‡¶∏‡¶¨ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶ö‡¶ø‡¶∞‡¶§‡¶∞‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá!")) {
                transactions = [];
                syncData();
                alert("‡¶∏‡¶¨ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
                toggleReports(false);
            }
        } else { alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!"); }
    }

    function syncData() {
        localStorage.setItem('sfvp_data', JSON.stringify(transactions));
        updateUI();
    }

    function updateUI() {
        const todayInc = calculate('income', 'today');
        const todayExp = calculate('expense', 'today');
        const totalInc = calculate('income', 'all');
        const totalExp = calculate('expense', 'all');

        document.getElementById('sum-income').innerText = `‡ß≥ ${todayInc}`;
        document.getElementById('sum-today').innerText = `‡ß≥ ${todayExp}`;
        document.getElementById('sum-net').innerText = `‡ß≥ ${totalInc - totalExp}`;

        renderList(transactions.slice(0, 5), 'recentList');
        renderList(transactions, 'fullList');
        updateChart(totalInc, totalExp);
    }

    function calculate(type, range) {
        const now = new Date();
        return transactions.filter(t => {
            if (t.type !== type) return false;
            if (range === 'today') return new Date(t.date).toDateString() === now.toDateString();
            return true;
        }).reduce((s, t) => s + t.amount, 0);
    }

    function renderList(data, elId) {
        const el = document.getElementById(elId);
        el.innerHTML = data.map(t => `
            <li class="transaction-item">
                <div class="item-info">
                    <div style="color:${t.type==='income'?'var(--accent-success)':'white'}">${t.category}: ‡ß≥ ${t.amount}</div>
                    <div>${new Date(t.date).toLocaleDateString('bn-BD')}</div>
                </div>
                <button class="btn-delete" onclick="deleteTransaction(${t.id})">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
            </li>
        `).join('');
    }

    let myChart;
    function updateChart(inc, exp) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['‡¶Ü‡ßü', '‡¶ñ‡¶∞‡¶ö'],
                datasets: [{ data: [inc, exp], backgroundColor: ['#4ade80', '#f87171'], borderWidth: 0 }]
            },
            options: { plugins: { legend: { labels: { color: '#fff' } } } }
        });
    }

    function startListening() {
        isListening = true; recognition.start();
        document.getElementById('btnStart').style.display = 'none';
        document.getElementById('btnStop').style.display = 'flex';
        document.getElementById('statusDot').classList.add('active');
        document.getElementById('statusLabel').innerText = "‡¶∂‡ßÅ‡¶®‡¶õ‡¶ø...";
    }

    function stopListening() {
        isListening = false; recognition.stop();
        document.getElementById('btnStart').style.display = 'flex';
        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('statusDot').classList.remove('active');
        document.getElementById('statusLabel').innerText = "‡¶Æ‡¶æ‡¶á‡¶ï‡ßç‡¶∞‡ßã‡¶´‡ßã‡¶® ‡¶¨‡¶®‡ßç‡¶ß";
    }

    function toggleReports(show) {
        document.getElementById('reportOverlay').style.display = show ? 'block' : 'none';
    }

    function changePassword() {
        if (prompt("‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°?") === appPassword) {
            const np = prompt("‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°?");
            if (np) { appPassword = np; localStorage.setItem('sfvp_pass', np); alert("‡¶∏‡¶´‡¶≤!"); }
        } else alert("‡¶≠‡ßÅ‡¶≤!");
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        return Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(), 0, 1))) / 86400000) + 1) / 7);
    }

    updateUI();
</script>
</body>
</html>
